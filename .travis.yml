language: python

env:
  global:
    - TOOL_VERSION=3.0.0
    - TOOL_NAME=RGCCA

before_install:
  - virtualenv .venv; . .venv/bin/activate
  - pip install "pip>=7"
  - pip install planemo
  - planemo conda_init

install:
  - planemo conda_install ${TRAVIS_BUILD_DIR}
  - sudo apt-get install -y libxml2-dev libcurl4-openssl-dev libssl-dev liblapack-dev r-base
  - sudo chmod 777 -R /usr/local/lib/R/site-library
  - Rscript -e 'install.packages(c("parallel", "pbapply", "grDevices", "ggplot2", "optparse", "scales", "igraph", "gridExtra", "Deriv", "plotly"), repos = "http://cran.us.r-project.org")'
  - git clone --depth 1 --single-branch --branch $TOOL_VERSION https://github.com/rgcca-factory/$TOOL_NAME
  - cd ${TRAVIS_BUILD_DIR}/${TOOL_NAME}
  - git checkout ${TOOL_VERSION}
  - cd ${TRAVIS_BUILD_DIR}
  - R CMD build --no-build-vignettes ${TOOL_NAME}
  - R -e "install.packages('"${TOOL_NAME}_${TOOL_VERSION}".tar.gz'"", repos = NULL, type = 'source')"
  - mv ${TRAVIS_BUILD_DIR}/${TOOL_NAME}/inst/launcher.R ${TRAVIS_BUILD_DIR}/launcher.R

script:
  - planemo lint ${TRAVIS_BUILD_DIR}
  - planemo test --conda_debug --no_cache_galaxy --galaxy_branch release_18.05 --file_path ${TRAVIS_BUILD_DIR} --job_output_files ${TRAVIS_BUILD_DIR} ${TRAVIS_BUILD_DIR}

after_script:
  - ls ${TRAVIS_BUILD_DIR}
  - cat tool_test_output.json